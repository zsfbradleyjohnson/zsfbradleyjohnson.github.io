---
layout: post
title:  "å¤šçº¿ç¨‹"
date:   2015-08-01 20:14:33
categories: iOS
comments: true
---
> &nbsp;&nbsp;&nbsp;&nbsp;å…·æœ‰å¤šçº¿ç¨‹èƒ½åŠ›çš„è®¡ç®—æœºå› æœ‰ç¡¬ä»¶æ”¯æŒè€Œèƒ½å¤Ÿåœ¨åŒä¸€æ—¶é—´æ‰§è¡Œå¤šäºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿›è€Œæå‡æ•´ä½“å¤„ç†æ€§èƒ½ã€‚ åœ¨ä¸€ä¸ªç¨‹åºä¸­ï¼Œè¿™äº›ç‹¬ç«‹è¿è¡Œçš„ç¨‹åºç‰‡æ®µå«ä½œâ€œçº¿ç¨‹â€ï¼ˆThreadï¼‰ï¼Œåˆ©ç”¨å®ƒç¼–ç¨‹çš„æ¦‚å¿µå°±å«ä½œâ€œå¤šçº¿ç¨‹å¤„ç†ï¼ˆMultithreadingï¼‰â€ã€‚å…·æœ‰å¤šçº¿ç¨‹èƒ½åŠ›çš„è®¡ç®—æœºå› æœ‰ç¡¬ä»¶æ”¯æŒè€Œèƒ½å¤Ÿåœ¨åŒä¸€æ—¶é—´æ‰§è¡Œå¤šäºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿›è€Œæå‡æ•´ä½“å¤„ç†æ€§èƒ½ã€‚

<br>

#### 1.å¤šçº¿ç¨‹åœ¨iOSä¸Šçš„å®ç°é€”å¾„
&nbsp;&nbsp;&nbsp;&nbsp;åœ¨iOSä¸Šï¼Œæˆ‘ä»¬å¸¸è§çš„å¤šçº¿ç¨‹æœ‰ä¸‰ç§ï¼š `NSThread`ã€ `NSOperation`ã€ `GCD`ã€‚ä»–ä»¬å¸¸è§çš„ä¼˜ç¼ºç‚¹åˆ†åˆ«å¦‚ä¸‹ï¼š
<br>
<br>
`NSThread`: æ›´ä¸ºè½»é‡çº§ã€‚ä½†æ˜¯éœ€è¦è‡ªå·±ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œçº¿ç¨‹åŒæ­¥ã€‚çº¿ç¨‹åŒæ­¥å¯¹æ•°æ®çš„åŠ é”ä¼šæœ‰ä¸€å®šçš„ç³»ç»Ÿå¼€é”€ã€‚
<br><br>
`NSOperation`: ä¸éœ€è¦å…³å¿ƒçº¿ç¨‹ç®¡ç†ï¼Œæ•°æ®åŒæ­¥çš„äº‹æƒ…ï¼Œå¯ä»¥æŠŠç²¾åŠ›æ”¾åœ¨è‡ªå·±éœ€è¦æ‰§è¡Œçš„æ“ä½œä¸Šã€‚ä½†æ˜¯å®ƒæ˜¯æŠ½è±¡ç±»ï¼Œä½¿ç”¨å®ƒå¿…é¡»ç”¨å®ƒçš„å­ç±»ï¼Œå¯ä»¥å®ç°å®ƒæˆ–è€…ä½¿ç”¨å®ƒå®šä¹‰å¥½çš„ä¸¤ä¸ªå­ç±»ï¼š`NSInvocationOperation` å’Œ `NSBlockOperation`ã€‚
<br><br>
`GCD`: å®ƒä¼šè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºçº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€é”€æ¯çº¿ç¨‹ï¼‰ï¼Œå®Œå…¨ä¸éœ€è¦æˆ‘ä»¬ç®¡ç†ï¼Œæˆ‘ä»¬åªéœ€è¦å‘Šè¯‰å¹²ä»€ä¹ˆå°±è¡Œã€‚è€Œä¸”å®ƒä½¿ç”¨äº†è¾ƒå¤šçš„Blockï¼Œæ›´åŠ çš„çµæ´»æ–¹ä¾¿ã€‚ä½†æ˜¯å®ƒæ˜¯åŸºäºCè¯­è¨€å°è£…çš„ï¼Œæ‰€ä»¥åœ¨å¯è¯»æ€§å’Œç†è§£æ€§ä¸Šæ²¡æœ‰é‚£ä¹ˆä¾¿æ·ã€‚

<br>
å…¶å®è¿˜æœ‰ä¸€ç§ `Pthreads` çš„å¤šçº¿ç¨‹æŠ€æœ¯ï¼Œå®ƒæ˜¯åœ¨ç±»Unixæ“ä½œç³»ç»Ÿï¼ˆUnixã€Linuxã€Mac OS Xç­‰ï¼‰ä¸­ï¼Œéƒ½ä½¿ç”¨Pthreadsä½œä¸ºæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ã€‚ç®€å•åœ°è¯´ï¼Œè¿™æ˜¯ä¸€å¥—åœ¨å¾ˆå¤šæ“ä½œç³»ç»Ÿä¸Šéƒ½é€šç”¨çš„å¤šçº¿ç¨‹APIï¼Œç§»æ¤æ€§å¾ˆå¼ºï¼Œå½“ç„¶åœ¨ iOS ä¸­ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚
<br>
ä¹Ÿå› ä¸ºå®ƒåœ¨iOSä¸Šçš„ä½¿ç”¨å‡ ä¹ä¸ºé›¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°±å¿½ç•¥å®ƒä¸è°ˆï¼Œè¿™é‡Œä½œä¸ºäº†è§£ä¸€ä¸‹çŸ¥é“å³å¯ã€‚

<br>

#### 2.å¤šçº¿ç¨‹ä½¿ç”¨- `NSThread`
&nbsp;&nbsp;&nbsp;&nbsp;`NSThread`è¿™å¥—æ–¹æ¡ˆæ˜¯ç»è¿‡è‹¹æœå°è£…åçš„ï¼Œå¹¶ä¸”å®Œå…¨é¢å‘å¯¹è±¡çš„ã€‚ä½ å¯ä»¥ç›´æ¥æ“æ§çº¿ç¨‹å¯¹è±¡ï¼Œååˆ†çš„ç›´è§‚å’Œæ–¹ä¾¿ã€‚ä½†æ˜¯ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸè¿˜æ˜¯éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ï¼Œæ‰€ä»¥è¿™å¥—æ–¹æ¡ˆä¸å¤ªå¸¸ç”¨ã€‚ä½†æ˜¯å…¶ä¸­çš„æŸäº›æ–¹æ³•ä¾‹å¦‚ `[NSThread currentThread]`ï¼Œå®ƒå¯ä»¥è·å–å½“å‰çº¿ç¨‹ç±»ï¼Œä½ å°±å¯ä»¥çŸ¥é“å½“å‰çº¿ç¨‹çš„å„ç§å±æ€§ï¼Œç”¨äºè°ƒè¯•ååˆ†æ–¹ä¾¿ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“å†™ä¸€å†™ä»£ç :<br>

&nbsp;&nbsp;&nbsp;&nbsp;åœ¨åˆ›å»ºä¸Šï¼Œæˆ‘ä»¬ä¸€å…±æœ‰3ç§æ–¹å¼ã€‚

1.

	#import "NSThreadViewController.h"
	
	@implementation NSThreadViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    	// çº¿ç¨‹åˆ›å»ºï¼Œæ‰§è¡Œ Target çš„ selector æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ object å‚æ•°
    	NSThread * thread = [[NSThread alloc] initWithTarget:self selector:@selector(waitForRun:) object:params];
    	
    	// å£°æ˜çº¿ç¨‹ä¼˜å…ˆçº§
    	thread.threadPriority = 1.0;
    	// ä¸ºçº¿ç¨‹å‘½åï¼Œä¾¿äºåŒºåˆ†
    	thread.name = @"ThreadTwo";
    	// å¯åŠ¨çº¿ç¨‹
    	[thread start];
	}
	@end

2.

	#import "NSThreadViewController.h"
	
	@implementation NSThreadViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    	
    	// çº¿ç¨‹åˆ›å»ºåç«‹åˆ»æ‰§è¡Œï¼Œæ‰§è¡Œ Target çš„ selector æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ object å‚æ•°
    	[NSThread detachNewThreadSelector:self toTarget:@selector(waitForRun:) withObject:params];
	}
	@end

3.

	#import "NSThreadViewController.h"
	
	@implementation NSThreadViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    	
    	// çº¿ç¨‹éšå¼åˆ›å»ºåç«‹åˆ»æ‰§è¡Œï¼Œæ‰§è¡Œ self çš„ selector æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ object å‚æ•°
    	[self performSelector:@selector(waitForRun:) withObject:params];

	}
	@end

è€Œæˆ‘ä»¬åœ¨çº¿ç¨‹ä¹‹é—´ï¼Œæ€»æ˜¯è¦è¿›è¡Œé€šè®¯ï¼Œå¸¸ç”¨çš„å‡ ç§é€šè®¯æ–¹æ³•æœ‰:<br>
`- (void)performSelectorOnMainThread:(SEL)aSelector withObject:(nullable id)arg waitUntilDone:(BOOL)wait;`
`- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thr withObject:(nullable id)arg waitUntilDone:(BOOL)wait NS_AVAILABLE(10_5, 2_0);`

<br>

ä¸‹é¢ï¼Œæˆ‘ä»¬ç”¨`NSThread`å†™ä¸€ä¸ªç»å…¸çš„å¼‚æ­¥çº¿ç¨‹ä¸‹è½½å›¾ç‰‡æ•°æ®ï¼Œå†å›åˆ°ä¸»çº¿ç¨‹åˆ·æ–°UIçš„å°Demoï¼š

	#import "NSThreadViewController.h"
	
	#define ImgUrl @"http://oaldigvho.bkt.clouddn.com/bradleyJohnson.jpg"
	
	@interface NSThreadViewController ()

	@property (nonatomic , strong) UIImageView * imgView;

	@end
	
	@implementation NSThreadViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    	
    	self.imgView = [[UIImageView alloc] initWithFrame:CGRectMake(0, 100, self.view.bounds.size.width, self.view.bounds.size.height-200)];
    	self.imgView.backgroundColor = [UIColor lightGrayColor];
    	[self.view addSubview:self.imgView];
    
    	NSThread * thread = [[NSThread alloc] initWithTarget:self selector:@selector(downLoadImageData:) object:ImgUrl];
    	thread.name = @"downloadData";
    	[thread start];
    	
    	NSLog(@"Main thread : %@",[NSThread currentThread]);
	}

	-(void)downLoadImageData:(NSString *)url
	{
    	NSData * data = [NSData dataWithContentsOfURL:[NSURL URLWithString:url]];
    
    	if (data) {
    		
        	NSLog(@"Ready for data thread : %@",[NSThread currentThread]);
        	// ä¼‘çœ ä¸¤ç§’
        	[NSThread sleepForTimeInterval:2];
        	
        	// è·³å›ä¸»çº¿ç¨‹åˆ·æ–° UI ï¼ˆçº¿ç¨‹é—´é€šè®¯å°±å‘ç”Ÿåœ¨è¿™é‡Œï¼‰
        	[self performSelectorOnMainThread:@selector(reloadUI:) withObject:data waitUntilDone:NO];
    	}
	}

	-(void)reloadUI:(NSData *)data
	{
		NSLog(@"Reload UI thread : %@",[NSThread currentThread]);
		    
    	self.imgView.image = [UIImage imageWithData:data];
	}
	
	@end

æ•ˆæœå¦‚å›¾ï¼š
<br><br>
![ä¸‹è½½å›¾ç‰‡](http://oaldigvho.bkt.clouddn.com/2.1-g.gif)

<br><br>
è€Œæˆ‘ä»¬çœ‹æˆ‘ä»¬çš„æ§åˆ¶å°çš„è¾“å‡ºï¼Œå¾ˆæ˜æ˜¾èƒ½çœ‹åˆ°æˆ‘ä»¬æ˜¯åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¿›è¡Œæ•°æ®äº¤æ¢:
<br><br>
![æ§åˆ¶å°](http://oaldigvho.bkt.clouddn.com/2.1.png)

<br><br>

#### 3.å¤šçº¿ç¨‹ä½¿ç”¨- `NSOperation`åŠ`NSOperationQueue`

##### 3.1 `NSInvocationOperation`å’Œ`NSBlockOperation`
&nbsp;&nbsp;&nbsp;&nbsp; `NSOperation` æ˜¯è‹¹æœå…¬å¸å¯¹ `GCD` çš„å°è£…ï¼Œå®Œå…¨é¢å‘å¯¹è±¡ï¼Œæ‰€ä»¥ä½¿ç”¨èµ·æ¥æ›´å¥½ç†è§£ã€‚ å¤§å®¶å¯ä»¥çœ‹åˆ° `NSOperation` å’Œ `NSOperationQueue` åˆ†åˆ«å¯¹åº” `GCD` çš„ä»»åŠ¡å’Œé˜Ÿåˆ— ã€‚æ“ä½œæ­¥éª¤ä¹Ÿå¾ˆå¥½ç†è§£ï¼š

å°†è¦æ‰§è¡Œçš„ä»»åŠ¡å°è£…åˆ°ä¸€ä¸ª `NSOperation` å¯¹è±¡ä¸­ã€‚<br>
å°†æ­¤ä»»åŠ¡æ·»åŠ åˆ°ä¸€ä¸ª `NSOperationQueue` å¯¹è±¡ä¸­ã€‚<br>

ç„¶åç³»ç»Ÿå°±ä¼šè‡ªåŠ¨æ‰§è¡Œä»»åŠ¡ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ`NSOperation`æ˜¯ä¸ªæŠ½è±¡ç±»æ— æ³•ç›´æ¥ä½¿ç”¨ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨å®ƒçš„å­ç±»`NSInvocationOperation`å’Œ`NSBlockOperation`æ¥åˆ›å»ºä»»åŠ¡å¯¹è±¡ï¼Œå†å¯¹å…¶è°ƒç”¨`start`æ–¹æ³•æ‰§è¡Œã€‚

	#import "NSThreadViewController.h"
	
	@implementation NSThreadViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    	// ä»»åŠ¡åˆ›å»ºï¼Œæ‰§è¡Œ Target çš„ selector æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ object å‚æ•°
    	NSInvocationOperation * invocationOpe = [[NSInvocationOperation alloc] initWithTarget:target selector:@selector(waitFroRun:) object:params];
    	
    	// å¯åŠ¨ä»»åŠ¡
    	[invocationOpe start];
	}
	@end

ä½†æ˜¯ï¼Œå¤§å®¶ä¼šå‘ç°ï¼Œè¿™æ˜¯åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ã€‚æ‰€ä»¥ä¸ºäº†å¹¶å‘æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`NSBlockOperation`æ¥åˆ›å»ºå’Œæ·»åŠ å¤šä»»åŠ¡ï¼Œè¿™æ ·å¤šä»»åŠ¡å°±ä¼šåœ¨ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹ä¸­å¹¶å‘æ‰§è¡Œã€‚
	
	#import "NSThreadViewController.h"
	
	@implementation NSThreadViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    	
    	NSBlockOperation * blockOperation = [NSBlockOperation blockOperationWithBlock:^{
        
        	//do something
        
    	}];
    
    	// æ·»åŠ å…¶å®ƒä»»åŠ¡è¿›æ¥
    	[blockOperation addExecutionBlock:^{
        
        	// add another block
        
    	}];
    
    	[blockOperation start];
	}
	@end
	
(æ³¨æ„ï¼š`addExecutionBlock`æ–¹æ³•å¿…é¡»åœ¨`start`æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼Œä¸ç„¶ä¼šå¼•èµ·å´©æºƒã€‚ï¼‰
<br>
<br>

å½“ç„¶äº†ï¼Œé™¤äº†ä¸Šé¢çš„ä¸¤ç§ `Operation` ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ `Operation`ã€‚è‡ªå®šä¹‰ `Operation` éœ€è¦ç»§æ‰¿ `NSOperation` ç±»ï¼Œå¹¶å®ç°å…¶ `main` æ–¹æ³•ï¼Œå› ä¸ºåœ¨è°ƒç”¨ `start` æ–¹æ³•çš„æ—¶å€™ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ `main` æ–¹æ³•å®Œæˆç›¸å…³é€»è¾‘ã€‚æ‰€ä»¥å¦‚æœä»¥ä¸Šçš„ä¸¤ä¸ªç±»æ— æ³•æ»¡è¶³ä½ çš„æ¬²æœ›çš„æ—¶å€™ï¼Œä½ å°±éœ€è¦è‡ªå®šä¹‰äº†ã€‚ä½ æƒ³è¦å®ç°ä»€ä¹ˆåŠŸèƒ½éƒ½å¯ä»¥å†™åœ¨é‡Œé¢ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä½ è¿˜éœ€è¦å®ç° `cancel` åœ¨å†…çš„å„ç§æ–¹æ³•ã€‚æ¯”è¾ƒéº»çƒ¦ï¼Œå¦‚æœæœ‰éœ€è¦å®šåˆ¶çš„æœ‹å‹ï¼Œå¯ä»¥è‡ªè¡Œç ”ç©¶ä¸€ä¸‹ã€‚

##### 3.2 `NSOperationQueue`
&nbsp;&nbsp;&nbsp;&nbsp; åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ä»»åŠ¡çš„å¹¶å‘ï¼Œä½†æ˜¯å¦‚æœæˆ‘è¿˜æ˜¯å¸Œæœ›æ‰€æœ‰çš„ä»»åŠ¡éƒ½åšå­çº¿ç¨‹ä¸­è¿›è¡Œï¼Œä¸æ¯«ä¸å½±å“æˆ‘çš„ä¸»çº¿ç¨‹ï¼Œé‚£è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™é‡Œï¼Œå°±æ¶‰åŠåˆ°äº†`NSOperationQueue`çš„ä½¿ç”¨äº†ã€‚<br>
&nbsp;&nbsp;&nbsp;&nbsp; åœ¨`NSOperationQueue`ä¸­ï¼Œçº¿ç¨‹åªæœ‰ä¸¤ç§ï¼Œä¸»çº¿ç¨‹å’Œå…¶å®ƒçº¿ç¨‹ï¼Œä¸»çº¿ç¨‹æˆ‘ä»¬å¯ä»¥é€šè¿‡ `[NSOperationQueue mainQueue]` è·å–åˆ°ï¼Œè€Œæ‰€æœ‰é€šè¿‡åˆ›å»ºè·å¾—çš„çº¿ç¨‹ï¼Œç»Ÿç»Ÿéƒ½æ˜¯å­çº¿ç¨‹ã€‚

	#import "NSThreadViewController.h"
	
	@implementation NSThreadViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    	
    	 NSBlockOperation * blockOperation = [NSBlockOperation blockOperationWithBlock:^{
        
        	//do something
        
    	}];
    
    	// æ·»åŠ å…¶å®ƒä»»åŠ¡è¿›æ¥
    	[blockOperation addExecutionBlock:^{
        
        	// add another block
        
    	}];
    
    	NSInvocationOperation * invocationOperation = [[NSInvocationOperation alloc] initWithTarget:target selector:@selector(waitForRun:) object:params];
    	
    	// åˆ›å»ºé˜Ÿåˆ—ï¼ˆå…¶å®ƒé˜Ÿåˆ—ï¼‰ï¼Œé˜Ÿåˆ—ä¸­çš„æ‰€ä»¥ä»»åŠ¡éƒ½æ˜¯å¹¶å‘è¿›è¡Œ ï¼Œå¦‚æœå¸Œæœ›æ˜¯ä¸²è¡Œï¼Œåˆ™å°†maxConcurrentOperationCount æœ€å¤§å¹¶å‘æ•°é‡ è®¾ç½®ä¸º1
    	NSOperationQueue * queue = [[NSOperationQueue alloc] init];
    	//        queue.maxConcurrentOperationCount = 1;
    	[queue addOperation:blockOperation];
    	[queue addOperation:invocationOperation];
	}
	@end

è€Œä¸”`NSOperation`æœ‰ä¸€ä¸ªååˆ†å®ç”¨çš„åŠŸèƒ½ï¼Œå°±æ˜¯ä»»åŠ¡ä¹‹é—´æ·»åŠ ä¾èµ–ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è§£é™¤ä¾èµ–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœAä»»åŠ¡çš„è¿›è¡Œå¿…é¡»å»ºç«‹åœ¨Bä»»åŠ¡çš„å®Œæˆä¹‹ä¸Šçš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨`addDependency`æ¥å°†Aä»»åŠ¡ä¾èµ–ç»™Bä»»åŠ¡ï¼š<br>

	#import "NSThreadViewController.h"
	
	@implementation NSThreadViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    	
    	 NSBlockOperation * blockOperationOne = [NSBlockOperation blockOperationWithBlock:^{
        
        	//do something
        
    	}];
    
    	NSBlockOperation * blockOperationTwo = [NSBlockOperation blockOperationWithBlock:^{
        
        	//do something
        
    	}];
    
    	NSBlockOperation * blockOperationThree = [NSBlockOperation blockOperationWithBlock:^{
        
        	//do something
        
    	}];
    
    	// æ·»åŠ ä¾èµ–
    	[blockOperationTwo addDependency:blockOperationOne];
    	[blockOperationThree addDependency:blockOperationTwo];
    
    	// è§£é™¤ä¾èµ–
		//    [blockOperationThree removeDependency:blockOperationTwo];
    
    	NSOperationQueue * queue = [[NSOperationQueue alloc] init];
    	[queue addOperations:@[blockOperationOne,blockOperationTwo,blockOperationThree] waitUntilFinished:NO];
    }
	@end

åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿé€šè¿‡`NSInvocationOperation`å’Œ`NSOperationQueue`æ¥å†™ä¸€ä¸ªç»å…¸çš„å¼‚æ­¥ä¸‹è½½æ•°æ®åŒæ­¥åˆ°ä¸»çº¿ç¨‹åˆ·æ–°UIçš„Demoï¼š


	#define ImgUrl @"http://oaldigvho.bkt.clouddn.com/bradleyJohnson.jpg"

	#import "NSOperationViewController.h"

	@interface NSOperationViewController ()

	@property (nonatomic , strong) UIImageView * imgView;

	@end

	@implementation NSOperationViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];

    	self.imgView = [[UIImageView alloc] initWithFrame:CGRectMake(0, 100, self.view.bounds.size.width, self.view.bounds.size.height-200)];
    	self.imgView.backgroundColor = [UIColor lightGrayColor];
    	[self.view addSubview:self.imgView];

    	NSInvocationOperation * invocationOperation = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(downLoadImageData:) object:ImgUrl];
    
    	NSOperationQueue * queue = [[NSOperationQueue alloc] init];
    	[queue addOperation:invocationOperation];
    
    	NSLog(@"Main thread : %@",[NSThread currentThread]);
	}

	-(void)downLoadImageData:(NSString *)url
	{
    	NSData * data = [NSData dataWithContentsOfURL:[NSURL URLWithString:url]];
    
    	if (data) {
        
        	NSLog(@"Ready for data thread : %@",[NSThread currentThread]);
        
        	[NSThread sleepForTimeInterval:2];
        
        	// è·³å›ä¸»çº¿ç¨‹åˆ·æ–° UI
        
        	NSInvocationOperation * invocationOperation = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(reloadUI:) object:data];
        
        	[[NSOperationQueue mainQueue] addOperation:invocationOperation];
    	}
	}

	-(void)reloadUI:(NSData *)data
	{
    	NSLog(@"Reload UI thread : %@",[NSThread currentThread]);
    
    	self.imgView.image = [UIImage imageWithData:data];
	}

	@end
	
æ•ˆæœå›¾åŸºæœ¬å¦‚åŒä¸Šä¸€ä¸ªï¼Œå°±ä¸å½•åˆ¶æ•ˆæœå›¾äº†ï¼Œä½†æ˜¯Logæ—¥å¿—è¿˜æ˜¯æ”¾ä¸€ä¸‹:
<br>
![Log](http://oaldigvho.bkt.clouddn.com/2.2.png)

<br><br>

#### 4.å¤šçº¿ç¨‹ä½¿ç”¨- `GCD`
&nbsp;&nbsp;&nbsp;&nbsp; `GCD`æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„ä¸œè¥¿ï¼Œå› ä¸ºå®ƒå‡ ä¹æ²¡æœ‰äº†ä»»åŠ¡çš„æ¦‚å¿µï¼Œä½ åªéœ€è¦åˆ›å»ºé˜Ÿåˆ—ï¼ŒæŒ‡å®šæ˜¯ä¸²è¡Œè¿˜æ˜¯å¹¶è¡Œï¼Œé€šè¿‡åŒæ­¥æˆ–å¼‚æ­¥æ–¹æ³•,å°±å¯ä»¥ç›´æ¥é€šè¿‡`Block`çš„æ–¹å¼æ·»åŠ ä»»åŠ¡ï¼Œåœ¨ä»£ç çš„é˜…è¯»æ€§ä¸Šï¼Œæ˜¯ååˆ†æµç•…çš„ã€‚
<br>ä¸€ä¸ªç®€å•å¼‚æ­¥å¹¶å‘æ“ä½œçš„ä¾‹å­å¦‚ä¸‹:

	#import "GCDViewController.h"

	@interface GCDViewController ()

	@end

	@implementation GCDViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    
    	// åˆ›å»ºé˜Ÿåˆ—ï¼Œå£°æ˜é˜Ÿåˆ—åç§°ï¼ŒæŒ‡å®šä¸ºå¹¶è¡Œé˜Ÿåˆ—
    	dispatch_queue_t queue = dispatch_queue_create("first.queue", DISPATCH_QUEUE_CONCURRENT);
    
    	// æŒ‡å®šå¼‚æ­¥æ“ä½œ
    	dispatch_async(queue, ^{
        	// æ·»åŠ ä»»åŠ¡
        	// do something
    	});
	}

	@end

##### 4.1 `GCD`-åˆ›å»ºé˜Ÿåˆ—
&nbsp;&nbsp;&nbsp;&nbsp; `GCD`å¯ä»¥è‡ªè¡Œåˆ›å»ºæŒ‡å®šåç§°å’ŒæŒ‡å®šå¹¶è¡Œæˆ–ä¸²è¡Œçš„é˜Ÿåˆ—ï¼Œä¹Ÿå¯ä»¥è·å–ç³»ç»Ÿä¸ºæˆ‘ä»¬å‡†å¤‡çš„å…¨å±€å¹¶è¡Œé˜Ÿåˆ—åŠä¸»é˜Ÿåˆ—ã€‚<br>
&nbsp;&nbsp;&nbsp;&nbsp; æˆ‘ä»¬é€šè¿‡`dispatch_queue_t`æ¥å£°æ˜è¿™æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé€šè¿‡`dispatch_queue_create(const char * _Nullable label,dispatch_queue_attr_t  _Nullable attr)`æ¥æŒ‡å®šåç§°å’ŒæŒ‡å®šå¹¶è¡Œæˆ–ä¸²è¡Œã€‚
<br>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåç§°å¿…é¡»æ˜¯Cå­—ç¬¦ä¸²å‹ï¼Œå³`"name"`ï¼Œä¸éœ€è¦åœ¨å‰é¢è·Ÿ`@`ã€‚
å³`dispatch_queue_create("queue_name", DISPATCH_QUEUE_CONCURRENT)`å¹¶è¡Œé˜Ÿåˆ—<br>
å’Œ`dispatch_queue_create("queue_name", DISPATCH_QUEUE_SERIAL)`ä¸²è¡Œé˜Ÿåˆ—ã€‚<br>

ä¹Ÿå¯ä»¥é€šè¿‡ï¼š
`dispatch_get_main_queue()`è·å–ä¸»é˜Ÿåˆ—<br>
å’Œ`dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0)`è·å–å…¨å±€å¹¶è¡Œé˜Ÿåˆ—ï¼Œå‰é¢çš„å‚æ•°ä¸ºé˜Ÿåˆ—ä¼˜å…ˆçº§ã€‚
<br>

##### 4.2 `GCD`-åŒæ­¥æˆ–å¼‚æ­¥
&nbsp;&nbsp;&nbsp;&nbsp; æˆ‘ä»¬åˆ›å»ºå¥½é˜Ÿåˆ—åï¼Œå°±åˆ°äº†å†³å®šå¼€åŒæ­¥æˆ–å¼‚æ­¥çš„æ—¶å€™äº†ã€‚å°±æ˜¯åœ¨æˆ‘ä»¬å°†é˜Ÿåˆ—æ”¾å…¥åŒæ­¥æˆ–å¼‚æ­¥æ‰§è¡Œä¸­çš„æ—¶å€™ï¼Œå†³å®šäº†è¯¥é˜Ÿåˆ—çš„æ‰§è¡Œçº¿ç¨‹ã€‚æ‰€æœ‰çš„åŒæ­¥æ“ä½œéƒ½åœ¨ä¸»çº¿ç¨‹ä¸­å®Œæˆï¼Œæ— è®ºå¹¶è¡Œæˆ–è€…ä¸²è¡Œã€‚è€Œå¼‚æ­¥æ“ä½œéƒ½ä¼šå¼€å¯å­çº¿ç¨‹ã€‚

	#import "GCDViewController.h"

	@interface GCDViewController ()

	@end

	@implementation GCDViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    
    	dispatch_queue_t queue1 = dispatch_queue_create("first.queue", DISPATCH_QUEUE_CONCURRENT);
    	dispatch_queue_t queue2 = dispatch_queue_create("first.queue", DISPATCH_QUEUE_SERIAL);
    
    	dispatch_sync(queue1, ^{
        	NSLog(@"q1 sync - the thread : %@",[NSThread currentThread]);
    	});
    
    	dispatch_async(queue1, ^{
        	NSLog(@"q1 async 1 - the thread : %@",[NSThread currentThread]);
    	});
    
    	dispatch_async(queue1, ^{
        	NSLog(@"q1 async 2 - the thread : %@",[NSThread currentThread]);
    	});
    
    	dispatch_async(queue1, ^{
        	NSLog(@"q1 async 3 - the thread : %@",[NSThread currentThread]);
    	});
    
    	dispatch_async(queue1, ^{
        	NSLog(@"q1 async 4 - the thread : %@",[NSThread currentThread]);
    	});
    
    	dispatch_sync(queue2, ^{
        	NSLog(@"q2 sync - the thread : %@",[NSThread currentThread]);
    	});
    
    	dispatch_async(queue2, ^{
        	NSLog(@"q2 async 1 - the thread : %@",[NSThread currentThread]);
    	});
    
    	dispatch_async(queue2, ^{
        	NSLog(@"q2 async 2 - the thread : %@",[NSThread currentThread]);
    	});
    	
    	dispatch_async(queue2, ^{
        	NSLog(@"q2 async 3 - the thread : %@",[NSThread currentThread]);
    	});
    
    	dispatch_async(queue2, ^{
        	NSLog(@"q2 async 4 - the thread : %@",[NSThread currentThread]);
    	});
        
    	NSLog(@"Main thread : %@",[NSThread currentThread]);
		}

	@end
<br>
è¿™é‡Œæˆ‘ä»¬åˆ›å»ºäº†å¹¶è¡Œå’Œä¸²è¡Œä¸¤ä¸ªé˜Ÿåˆ—ï¼Œåˆ†åˆ«åœ¨åŒæ­¥å’Œå¼‚æ­¥ä¸­æ‰§è¡Œï¼Œæˆ‘ä»¬çœ‹çœ‹æ‰“å°:<br>
![Log](http://oaldigvho.bkt.clouddn.com/2.4.png)
æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°å¼‚æ­¥å¹¶è¡Œé˜Ÿåˆ—çš„Logé¡ºåºæ˜¯æ— åºçš„ï¼Œè¯´æ˜å¼‚æ­¥å¹¶è¡Œé˜Ÿåˆ—å¼€å¯äº†å¤šä¸ªå­çº¿ç¨‹ã€‚è€Œå¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—å´æ˜¯ç”¨åŒä¸€ä¸ªéä¸»çº¿ç¨‹å†…å­˜åœ°å€æŒ‰é¡ºåºæ‰“å°ï¼Œè¯´æ˜åªå¼€å¯äº†ä¸€ä¸ªå­çº¿ç¨‹ã€‚è€Œæ‰€æœ‰çš„åŒæ­¥æ“ä½œï¼Œéƒ½åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œã€‚

è¿˜æ˜¯è€è§„çŸ©ï¼Œæˆ‘ä»¬åŒ`GCD`æ¥å†™é‚£ä¸ªç»å…¸å¼‚æ­¥ä¸‹è½½å›¾ç‰‡æ•°æ®ï¼Œå†å›åˆ°ä¸»çº¿ç¨‹åˆ·æ–°UIçš„Demoï¼š<br>

	#define ImgUrl @"http://oaldigvho.bkt.clouddn.com/bradleyJohnson.jpg"

	#import "GCDViewController.h"

	@interface GCDViewController ()

	@property (nonatomic , strong) UIImageView * imgView;

	@end

	@implementation GCDViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];

    	self.imgView = [[UIImageView alloc] initWithFrame:CGRectMake(0, 100, self.view.bounds.size.width, self.view.bounds.size.height-200)];
    	self.imgView.backgroundColor = [UIColor lightGrayColor];
    	[self.view addSubview:self.imgView];
    
		dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
        	[self downLoadImageData:ImgUrl];
    	});
    
    
    	NSLog(@"Main thread : %@",[NSThread currentThread]);

	}

	-(void)downLoadImageData:(NSString *)url
	{
    	NSData * data = [NSData dataWithContentsOfURL:[NSURL URLWithString:url]];
    
    	if (data) {
        
        	NSLog(@"Ready for data thread : %@",[NSThread currentThread]);
        
        	[NSThread sleepForTimeInterval:2];
        
        	// è·³å›ä¸»çº¿ç¨‹åˆ·æ–° UI
        	dispatch_async(dispatch_get_main_queue(), ^{
            	[self reloadUI:data];
        	});
    	}
	}

	-(void)reloadUI:(NSData *)data
	{
    	NSLog(@"Reload UI thread : %@",[NSThread currentThread]);
    
    	self.imgView.image = [UIImage imageWithData:data];
	}

	@end
	
æ•ˆæœå’ŒLogç›¸ä¿¡å¤§å®¶ä¹Ÿéƒ½èƒ½çŒœå¾—åˆ°ï¼Œå°±ä¸è´´å›¾äº†ã€‚
<br>

##### 4.3 `GCD`-é˜Ÿåˆ—ç»„
&nbsp;&nbsp;&nbsp;&nbsp; æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›å®Œæˆä¸€äº›é˜Ÿåˆ—çš„ä»»åŠ¡åï¼Œå†å»å®ŒæˆæŸä¸ªæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰é˜Ÿåˆ—ç»„çš„æ¦‚å¿µã€‚æ„æ€å°±æ˜¯è¯´ï¼Œæˆ‘ä»¬é€šè¿‡æŠŠä¸€äº›é˜Ÿåˆ—æ”¾è¿›æŸä¸ªç»„ä¸­ï¼Œå½“ç»„å†…çš„æ‰€ä»¥é˜Ÿåˆ—çš„æ“ä½œå®Œæˆåï¼Œç»„ä¼šè§¦å‘ä¸€ä¸ª`dispatch_group_notify`çš„æ–¹æ³•æ¥é€šçŸ¥æˆ‘ä»¬ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™é‡Œé¢è¿›è¡Œæˆ‘ä»¬æœ€åçš„æ“ä½œã€‚<br>

	#import "GCDViewController.h"

	@implementation GCDViewController

	- (void)viewDidLoad {
    	[super viewDidLoad];
    
    	// åˆ›å»ºé˜Ÿåˆ—ç»„
    	dispatch_group_t group = dispatch_group_create();
    
    	dispatch_queue_t queueOne = dispatch_queue_create("queue.one", DISPATCH_QUEUE_CONCURRENT);
    	dispatch_queue_t queueTwo = dispatch_queue_create("queue.two", DISPATCH_QUEUE_CONCURRENT);
    
    	// é˜Ÿåˆ—ç»„å¼‚æ­¥å®Œæˆé˜Ÿåˆ—ä»»åŠ¡
    	dispatch_group_async(group, queueOne, ^{
        	//do something
    	});
    	// é˜Ÿåˆ—ç»„å¼‚æ­¥å®Œæˆé˜Ÿåˆ—ä»»åŠ¡
    	dispatch_group_async(group, queueTwo, ^{
        	//do something
    	});
    	// é˜Ÿåˆ—ç»„å®Œæˆæ‰€æœ‰é˜Ÿåˆ—ä»»åŠ¡è§¦å‘é€šçŸ¥æ–¹æ³•
    	dispatch_group_notify(group, dispatch_get_main_queue(), ^{
        	NSLog(@"Finish");
    	});
    
	}

	@end





***

ä¸‹é¢æ˜¯ä¸€ä¸ªé€šè¿‡`NSLock`åŠ é”çš„æŠ¢ç¥¨Demoï¼Œåˆ†åˆ«é€šè¿‡`NSThread`ã€`NSOperation`ã€`GCD`å®ç°çš„Demoã€‚å…·ä½“ä»£ç ä¸è´´äº†ï¼Œéœ€è¦çš„å¯ä»¥å»ğŸ‘‡çš„Githubä¸Šä¸‹è½½æ¥çœ‹çœ‹ã€‚

<br>
<br>
å¦‚æœä½ æƒ³è¦çœ‹åˆ°æºç ï¼Œå¯ä»¥åˆ°æˆ‘çš„githubä¸Šä¸‹è½½ä½¿ç”¨ï¼š[Demo](https://github.com/zsfbradleyjohnson/multithreadingDemo)ã€‚

***

å¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œè¯·ä¸è¦åå•¬ä½ çš„å–œæ¬¢å’Œå…³æ³¨ï¼Œè¿™æ˜¯æˆ‘çš„[ç®€ä¹¦](http://www.jianshu.com/users/91577acf333a/latest_articles).